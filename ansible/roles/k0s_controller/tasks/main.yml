- name: Download k0s binary
  get_url:
    url: https://get.k0s.sh
    dest: /tmp/install_k0s.sh
    mode: '0755'

- name: Install k0s
  command: sh /tmp/install_k0s.sh
  args:
    creates: /usr/local/bin/k0s

# =========================
# ENSURE k0s CONFIG DIRECTORY
# =========================
- name: Ensure /etc/k0s directory exists
  file:
    path: /etc/k0s
    state: directory
    owner: root
    group: root
    mode: '0755'

# =========================
# CREATE k0s CLUSTER CONFIG (MULTI-NODE)
# =========================
- name: Create k0s cluster config
  copy:
    dest: /etc/k0s/k0s.yaml
    mode: '0644'
    content: |
      apiVersion: k0s.k0sproject.io/v1beta1
      kind: Cluster
      metadata:
        name: k0s-cluster
      spec:
        api:
          address: {{ ansible_host }}
          sans:
            - {{ ansible_host }}
            - 127.0.0.1
        storage:
          type: etcd
        network:
          provider: kuberouter

# =========================
# INSTALL CONTROLLER (KHÔNG DÙNG --single)
# =========================
- name: Install k0s controller
  command: k0s install controller --config /etc/k0s/k0s.yaml
  args:
    creates: /etc/systemd/system/k0scontroller.service

- name: Start k0s controller
  systemd:
    name: k0scontroller
    enabled: yes
    state: started

- name: Wait for k0s API ready
  wait_for:
    port: 6443
    delay: 10
    timeout: 300

# =========================
# CREATE WORKER JOIN TOKEN
# =========================
- name: Create worker join token
  command: k0s token create --role=worker
  register: worker_token
  changed_when: false

- name: Set worker token fact
  set_fact:
    k0s_worker_token: "{{ worker_token.stdout }}"
