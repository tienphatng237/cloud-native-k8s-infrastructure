---
- name: Ensure kubeconfig is available
  command: k0s kubectl version --client
  changed_when: false

# =========================
# INSTALL METALLB CRDs
# =========================
- name: Install MetalLB IPAddressPool CRD
  command: k0s kubectl apply -f https://raw.githubusercontent.com/metallb/metallb/v0.14.5/config/crd/bases/metallb.io_ipaddresspools.yaml

- name: Install MetalLB L2Advertisement CRD
  command: k0s kubectl apply -f https://raw.githubusercontent.com/metallb/metallb/v0.14.5/config/crd/bases/metallb.io_l2advertisements.yaml

# =========================
# DEPLOY METALLB CORE (RBAC + CONTROLLER + SPEAKER)
# =========================
- name: Deploy MetalLB core components
  command: k0s kubectl apply -f https://raw.githubusercontent.com/metallb/metallb/v0.14.5/config/manifests/metallb-native.yaml

# =========================
# WAIT FOR METALLB READY
# =========================
- name: Wait for MetalLB controller to be ready
  command: k0s kubectl -n metallb-system rollout status deploy/controller
  register: metallb_rollout
  retries: 15
  delay: 10
  until: metallb_rollout.rc == 0

# =========================
# CONFIGURE IP POOL
# =========================
- name: Configure MetalLB IP pool
  command: k0s kubectl apply -f -
  args:
    stdin: "{{ lookup('template', 'metallb-ip-pool.yaml.j2') }}"
